var dishes = [{ "typeID": 1, "typeName": "推荐", "typeOrder": 1, "dishID": 1, "dishName": "佛跳墙", "price": 888.88, "description": "佛跳墙，又名满坛香、福寿全，是福建福州的当地名菜，属闽菜系。相传，它是在清道光年间由福州聚春园菜馆老板郑春发研制出来的。佛跳墙富含营养，可促进发育，美容，延缓衰老，增强免疫力，乃进补佳品。制作这道美食，工序十分繁琐。", "dishOrder": 1, "imageFile": "BuddhaVPN.jpg", "mustOrder": 0, "discount": 5 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 6, "dishName": "清汤锅底", "price": 28, "description": "就是白开水涮火锅了啦", "dishOrder": 1, "imageFile": "water.jpg", "mustOrder": 2, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 7, "dishName": "红油锅底", "price": 38, "description": "不辣不革命", "dishOrder": 2, "imageFile": "redoil.jpg", "mustOrder": 2, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 8, "dishName": "鸳鸯锅底", "price": 48, "description": "四张机，鸳鸯织就欲双飞。可怜未老先白头，春波碧草，晓寒深处，相对浴红衣。", "dishOrder": 3, "imageFile": "lovebirds.jpg", "mustOrder": 2, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 9, "dishName": "药膳锅底", "price": 58, "description": "药补不如食补", "dishOrder": 4, "imageFile": "drug.jpg", "mustOrder": 2, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 10, "dishName": "涮鸡蛋", "price": 18, "description": "鸡蛋涮着吃，没见过吧？", "dishOrder": 5, "imageFile": "egg.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 11, "dishName": "鱼鱼鱼", "price": 48, "description": "鱼真的会游泳？我不信！", "dishOrder": 6, "imageFile": "fish.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 12, "dishName": "鸡腿", "price": 38, "description": "好像跟鸡干上了？~~~~~wuwuwu.....", "dishOrder": 7, "imageFile": "leg.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 2, "typeName": "火锅", "typeOrder": 2, "dishID": 13, "dishName": "樱桃洗澡", "price": 58, "description": "火锅洗樱桃，可以洗白的哦，我书读得多，不会骗你的！", "dishOrder": 8, "imageFile": "cherry.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 3, "typeName": "凉菜", "typeOrder": 3, "dishID": 2, "dishName": "凉拌牛肉", "price": 38, "description": "桂皮1小段 盐适量 大葱1段 姜3片 大蒜1个 干辣椒若干 香菜1小把 秘制拌牛肉丝的做法步骤 1. 1.高压锅烀牛肉。", "dishOrder": 1, "imageFile": "beef.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 3, "typeName": "凉菜", "typeOrder": 3, "dishID": 3, "dishName": "凉拌黄瓜", "price": 38, "description": "凉拌黄瓜真好吃", "dishOrder": 2, "imageFile": "cucumber.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 4, "typeName": "酒水", "typeOrder": 4, "dishID": 14, "dishName": "闷倒驴", "price": 298, "description": "你比驴害牛么？敢不敢试试？", "dishOrder": 1, "imageFile": "donkey.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 4, "typeName": "酒水", "typeOrder": 4, "dishID": 15, "dishName": "老村长", "price": 8, "description": "俺没啥说的，就是个便宜管够！", "dishOrder": 2, "imageFile": "oldleader.png", "mustOrder": 0, "discount": 10 }, { "typeID": 4, "typeName": "酒水", "typeOrder": 4, "dishID": 16, "dishName": "天然VC饮品", "price": 88, "description": "美容的哦，别人我不告诉他", "dishOrder": 3, "imageFile": "juice.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 4, "typeName": "酒水", "typeOrder": 4, "dishID": 17, "dishName": "铁观音", "price": 68, "description": "铁观音跟佛跳墙才最配", "dishOrder": 4, "imageFile": "tea.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 4, "typeName": "酒水", "typeOrder": 4, "dishID": 18, "dishName": "拿铁", "price": 88, "description": "俺来自Moonbucks,Starbucks神马的都弱爆了,拿铁的意思奏是拿翻铁观音", "dishOrder": 5, "imageFile": "coffee.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 5, "typeName": "主食", "typeOrder": 5, "dishID": 19, "dishName": "米饭", "price": 8, "description": "不要点太多,会被人认为是吃干饭的", "dishOrder": 1, "imageFile": "rice.jpg", "mustOrder": 1, "discount": 10 }, { "typeID": 5, "typeName": "主食", "typeOrder": 5, "dishID": 20, "dishName": "蛋卷？", "price": 38, "description": "不好意思,图片网上找的,我都不知道是个什么,将就吃吧", "dishOrder": 2, "imageFile": "roll.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 5, "typeName": "主食", "typeOrder": 5, "dishID": 21, "dishName": "蛋糕", "price": 38, "description": "其实叫我饼干也很好", "dishOrder": 3, "imageFile": "cake.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 5, "typeName": "主食", "typeOrder": 5, "dishID": 22, "dishName": "睡觉", "price": 38, "description": "普通话不标准,见谅", "dishOrder": 4, "imageFile": "dumpling.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 5, "typeName": "主食", "typeOrder": 5, "dishID": 23, "dishName": "面条", "price": 28, "description": "越吃越苗条,谁吃谁知道", "dishOrder": 5, "imageFile": "noodle.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 6, "typeName": "杂项", "typeOrder": 6, "dishID": 4, "dishName": "冰淇淋", "price": 28, "description": "我有一杯冰淇淋，就不给你吃", "dishOrder": 1, "imageFile": "icecream.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 6, "typeName": "杂项", "typeOrder": 6, "dishID": 5, "dishName": "冰棒", "price": 18, "description": "跟冰激凌一起吃才更搭哦", "dishOrder": 2, "imageFile": "icestick.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 24, "dishName": "猪头", "price": 88, "description": "吃啥补啥,没啥说的", "dishOrder": 1, "imageFile": "pighead.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 25, "dishName": "红烧蹄子", "price": 68, "description": "有没有自残骨肉的感觉？嘿嘿", "dishOrder": 2, "imageFile": "pork.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 26, "dishName": "红烧肉", "price": 78, "description": "传统经典吃法,地球人都直到", "dishOrder": 3, "imageFile": "redpork.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 27, "dishName": "道口烧鸡", "price": 128, "description": "唧唧复唧唧 VS 格机格机格机格机", "dishOrder": 4, "imageFile": "chicken.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 28, "dishName": "螃蟹", "price": 138, "description": "横着走的,拽得很哈,看我怎么对付你", "dishOrder": 5, "imageFile": "crab.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 29, "dishName": "撸串", "price": 28, "description": "跟啤酒最配哦", "dishOrder": 6, "imageFile": "chuan.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 30, "dishName": "东坡肉", "price": 158, "description": "山寨的啦,东坡是文物,吃他的肉犯法", "dishOrder": 7, "imageFile": "dongpo.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 31, "dishName": "海捕大虾", "price": 88, "description": "青岛的,88是一只的价格,看清楚再点哦", "dishOrder": 8, "imageFile": "shrimp.jpg", "mustOrder": 0, "discount": 10 }, { "typeID": 7, "typeName": "热菜", "typeOrder": 7, "dishID": 32, "dishName": "小龙虾", "price": 58, "description": "这货厚道,按盘算,不是按只算,尽管点,吃不完喊我来", "dishOrder": 9, "imageFile": "little_shrimp.jpg", "mustOrder": 0, "discount": 10 }];

var orders = [],
    dishTypes = [],
    optTypes = [];

function getDishIndex(dishID) {
    for (var i = 0; i < dishes.length; i++) {
        if (dishes[i].dishID == dishID) return i;
    }
    return -1;
}

function mustOrder() {
    var i = 0,
        j,
        inIt = true,
        tID, dIndex;

    for (; i < dishes.length; i++) {

        if (dishes[i].mustOrder === 1) { // 全单必选项
            inIt = false;
            for (j = 0; j < orders.length; j++) {
                if (dishes[i].dishID === orders[j].dishID) {
                    inIt = true;
                    break;
                }
            }
            if (!inIt) return '类别为' + dishes[i].typeName + '中的' + dishes[i].dishName + '为必选,请选择！';
        }
    }

    for (i = 0; i < dishes.length; i++) {
        if (dishes[i].mustOrder == 2) {
            tid = dishes[i].typeID;
            if (optTypes.indexOf(tid) < 0) optTypes.push(tid);
        }
    }

    for (i = 0; i < orders.length; i++) {
        dIndex = getDishIndex(orders[i].dishID);
        inIt = true;
        if (orders[i].count > 0 && dishes[dIndex].mustOrder === 0) {
            inIt = false;
            tid = getDishTypeIDByDishID(orders[i].dishID);
            if (optTypes.indexOf(tid) >= 0) {
                inIt = orders.some(function(value) {
                    return tid === getDishTypeIDByDishID(value.dishID) && dishes[getDishIndex(value.dishID)].mustOrder === 2;
                });
                if (!inIt) return '类别为' + dishes[dIndex].typeName + '中选了' + dishes[dIndex].dishName + '但是没选必选项';
            }
        }
    }

    return '';
}

function orderIt() {
    var i = 0;
    var m = '';

    m = mustOrder();
    if (m !== '') {
        myApp.alert(m);
        return;
    }
    for (; i < orders.length; i++) {
        orders[i].count = 0;
        showDishCount(orders[i].dishID);
    }
    displayOrderCount();
    orders = [];
    myApp.alert('下单成功!');
    toggleOrderDetailPage();
}

function toggleOrderDetailPage() {
    var elem,
        i = 0,
        total = 0,
        dIndex,
        html;

    elem = document.getElementById('page_orderDetail');
    html = '<table class="tableMenu" width="100%" border="1"><tr><td width="15%">序号</td><td width="25%">菜名</td><td width="20%">单价</td><td width="20%">数量</td><td>小计</td></tr>';

    if (elem.hasAttribute('hidden')) {
        if (orders.length < 1) { return; }
        for (; i < orders.length; i++) {
            if (orders[i].count < 1) continue;
            dIndex = dishIndex(orders[i].dishID);
            html += '<tr><td class="number">' + (i + 1) + '</td><td>' + dishes[dIndex].dishName + '</td><td class="number">';
            html += dishes[dIndex].priceAfterDiscount + '</td><td class="number">';
            html += orders[i].count + '</td><td class="number">';
            html += orders[i].count * dishes[dIndex].priceAfterDiscount + '</td></tr>';
            total += orders[i].count * dishes[dIndex].priceAfterDiscount;
        }
        html += '<tr><td>合计</td><td class="number" colspan="4" style="margin-right:0">' + total + '</td></tr></table>';
        if (total > 0) {
            elem.removeAttribute('hidden');
            elem = document.getElementById('orderdDishesList');
            elem.innerHTML = html;
        } else {
            return;
        }
    } else {
        elem.setAttribute('hidden', 'true');
    }
}

function showPage(pageNo) {
    var pageID, elem;
    for (var i = 0; i < dishTypes.length; i++) {
        pageID = 'page_' + dishTypes[i];
        elem = document.getElementById(pageID);
        if (pageNo === dishTypes[i]) {
            elem.style.display = 'block';
        } else {
            elem.style.display = 'none';
        }
    }
}

function displayOrderCount() {
    var i, elemID, dishID, typeID, dIndex, tIndex, elem, typeCount = 0;
    var totalDish = 0,
        totalFee = 0;

    for (i = 0; i < orders.length; i++) {
        if (orders.count < 1) continue;
        totalDish += orders[i].count;
        dishID = orders[i].dishID;
        dIndex = dishIndex(dishID);
        totalFee += dishes[dIndex].priceAfterDiscount * orders[i].count;
        typeID = getDishTypeIDByDishID(dishID);
        elemID = 'toolBar_badge_' + typeID;
        elem = document.getElementById(elemID);
        typeCount = calcOrderTypeCount(typeID);
        if (typeCount) {
            elem.innerHTML = '<span class="badge bg-red">' + typeCount + '</span>';
        } else {
            elem.innerHTML = '';
        }
        elemID = 'orderMenu';
        elem = document.getElementById(elemID);
        if (totalDish > 0) {
            elem.innerHTML = '下单<span class="badge bg-red">' + totalDish + '</span>';
        } else {
            elem.innerHTML = '下单';
        }
        elemID = 'serviceMenu';
        elem = document.getElementById(elemID);
        if (totalFee > 0) {
            elem.innerHTML = '服务<span class="badge bg-red">￥' + totalFee + '</span>';
        } else {
            elem.innerHTML = '服务';
        }
    }
}

function typeIndex(typeID) {
    for (var i = 0; i < dishes.length; i++) {
        if (dishes[i].typeID === typeID) {
            return i;
        }
    }
    return -1;
}

function calcOrderTypeCount(typeID) {
    var count = 0,
        i = 0,
        dishID;

    for (; i < orders.length; i++) {
        dishID = orders[i].dishID;
        if (typeID === getDishTypeIDByDishID(dishID)) {
            count += orders[i].count;
        }
    }
    return count;
}

function getDishTypeIDByDishID(dishID) {
    for (var i = 0; i < dishes.length; i++) {
        if (dishes[i].dishID === dishID) {
            return dishes[i].typeID;
        }
    }
    return -1;
}

function dishIndex(dishID) {
    for (var i = 0; i < dishes.length; i++) {
        if (dishes[i].dishID === dishID) return i;
    }
    return -1;
}

function showDishCount(dishID) {
    var elemDecrease, elemCount, elemID;
    var dishCount, i;

    for (i = 0; i < orders.length; i++) {
        if (orders[i].dishID === dishID) {
            dishCount = orders[i].count;
            break;
        }
    }

    elemID = 'decreaseDish_' + dishID;
    elemDecrease = document.getElementById(elemID);
    elemID = 'dishCount_' + dishID;
    elemCount = document.getElementById(elemID);

    if (dishCount < 1) {
        elemDecrease.setAttribute('hidden', 'true');
        elemCount.setAttribute('hidden', 'true');
    } else {
        elemDecrease.removeAttribute('hidden');
        elemCount.removeAttribute('hidden');
        elemCount.innerHTML = dishCount;
    }
}

function orderChange(typeID, dishID) {
    var order = {};
    var changeCount = 1;
    var i, j, dIndex;
    var isNew = true;
    var elem, elemID;

    if (dishID < 0) changeCount = -1;
    dishID = Math.abs(dishID);

    dIndex = dishIndex(dishID);
    if (orders.length < 1) {
        order.dishID = dishID;
        order.count = 1;
        orders.push(order);
    } else {
        for (i = 0; i < orders.length; i++) {
            if (orders[i].dishID === dishID) {
                orders[i].count += changeCount;
                isNew = false;
                break;
            }
        }
        if (isNew) {
            order.dishID = dishID;
            order.count = 1;
            orders.push(order);
        }
    }
    showDishCount(dishID);
    displayOrderCount();
}

function typeStars(typeID) {
    starts = 0;
    for (var i = 0; i < dishes.length; i++) {
        if (dishes[i].typeID == typeID) starts = Math.max(starts, dishes[i].mustOrder);
    }
    switch (starts) {
        case 0:
            return '';
        case 1:
            return '**';
        case 2:
            return '*';
    }
}

function genData() {
    var toolBar = '',
        content = '',
        i,
        currTypeID = 0,
        elem;
    //  class="link close-panel"
    for (i = 0; i < dishes.length; i++) {
        // for (i = 0; i < 1; i++) {
        if (currTypeID !== dishes[i].typeID) {
            currTypeID = dishes[i].typeID;
            dishTypes.push(currTypeID);
            // toolBar += '<p><a href="#dishList_' + currTypeID + '">' + dishes[i].typeName;
            // toolBar += '<span id="toolBar_badge_' + currTypeID + '"></span></a></p>';
            toolBar += '<p><a href="#" class="close-panel" onclick="showPage(' + currTypeID + ')">' + dishes[i].typeName + typeStars(currTypeID);
            toolBar += '<span id="toolBar_badge_' + currTypeID + '"></span></a></p>';
            if (content === '') {
                content = '<div id="page_' + currTypeID + '" data-page="page_' + currTypeID + '" class="page">\n';
            } else {
                content += ' </table>\n</div>\n</div>\n<div id="page_' + currTypeID + '" class = "page cached" data-page="page_' + currTypeID + '">\n';
            }
            content += '<div class="page-content">\n<table id="tableContent' + currTypeID;
            content += '" width="100%" style="font-size:1.2rem">\n';
            content += '<div>\n<a name="dishList_' + currTypeID + '" id="dishList_' + currTypeID + '"></a>\n<tr ';
        } else {
            content += '<div>\n<tr ';
        }
        content += 'style="margin:0;padding:0" border=1>\n<td width="64%" style="margin:0;padding:0">\n';
        content += '<img src="image/' + dishes[i].imageFile + '" width="100%" style="margin:0;padding:0"></img>\n';
        content += '</td>\n<td>\n<table width="100%">\n<tr>\n<td id="dishName_' + dishes[i].dishID + '">';
        switch (dishes[i].mustOrder) {
            case 0:
                content += dishes[i].dishName;
                break;
            case 1:
                content += dishes[i].dishName + '**';
                break;
            case 2:
                content += dishes[i].dishName + '*';
                break;
        }
        content += '</td>\n</tr>\n<tr>\n<td id="dishPrice_' + dishes[i].dishID + '">';
        if (dishes[i].discount !== 10) {
            content += '<del>￥' + dishes[i].price + '元</del></td>\n';
        } else {
            content += '￥' + dishes[i].price + '元</td>\n';
        }
        content += '</tr>\n<tr>\n<td id="dishPriceAfterDiscount_' + dishes[i].dishID + '">\n';
        dishes[i].priceAfterDiscount = Math.ceil(dishes[i].price * dishes[i].discount / 10);
        if (dishes[i].discount !== 10) {
            content += '￥' + dishes[i].priceAfterDiscount + '元\n';
        }
        content += '</td>\n</tr>\n<tr>\n<td style="color:red;font-size:2.5rem;text-align:right">\n';
        content += '<a id="decreaseDish_' + dishes[i].dishID + '" ';
        content += 'onclick="orderChange(' + dishes[i].typeID + ',-' + dishes[i].dishID;
        content += ');" hidden>-</a>\n<span id="dishCount_';
        content += dishes[i].dishID + '" hidden>0</span>\n<a id="plusDish_' + dishes[i].dishID;
        content += '" onclick="orderChange(';
        content += dishes[i].typeID + ',' + dishes[i].dishID + ')';
        content += ';">\n+\n</a>\n</td>\n</tr>\n</table>\n</td>\n</tr>\n<tr>\n<td colspan="2" id="dishDescription_';
        content += dishes[i].dishID;
        content += '">\n' + dishes[i].description + '</td>\n</tr>\n</div>\n';
    }
    content += '</table></div></div>';
    elem = document.getElementById('leftSideMenu');
    elem.innerHTML += toolBar;
    elem = document.getElementById('pages');
    elem.innerHTML += content;

    // console.log(toolBar);
}